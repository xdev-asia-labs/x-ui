name: Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          publish: pnpm release
          version: pnpm version-packages
          title: 'chore: release packages'
          commit: 'chore: release packages'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to GitHub Package Registry
        if: steps.changesets.outputs.published == 'true'
        run: |
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> ~/.npmrc
          echo "@xdev-asia:registry=https://npm.pkg.github.com" >> ~/.npmrc
          pnpm publish --filter "@xdev-asia/*" --access public --no-git-checks || echo "Some packages may already exist on GPR"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Git Tags for Released Packages
        if: steps.changesets.outputs.published == 'true'
        run: |
          echo "üì¶ Creating git tags for released packages..."
          
          # Read published packages from changesets output
          PUBLISHED='${{ steps.changesets.outputs.publishedPackages }}'
          
          if [ -n "$PUBLISHED" ] && [ "$PUBLISHED" != "[]" ]; then
            echo "$PUBLISHED" | jq -r '.[] | "\(.name)@\(.version)"' | while read TAG; do
              echo "üè∑Ô∏è Creating tag: $TAG"
              git tag "$TAG" || echo "Tag $TAG already exists"
            done
            
            # Push all tags
            git push --tags
            echo "‚úÖ All tags pushed successfully!"
          else
            echo "‚ÑπÔ∏è No packages were published, skipping tag creation."
          fi

      - name: Format Published Packages
        if: steps.changesets.outputs.published == 'true'
        id: format-packages
        run: |
          echo "PACKAGES_TABLE<<EOF" >> $GITHUB_OUTPUT
          echo "| Package | Version |" >> $GITHUB_OUTPUT
          echo "|---------|---------|" >> $GITHUB_OUTPUT
          echo '${{ steps.changesets.outputs.publishedPackages }}' | jq -r '.[] | "| \(.name) | \(.version) |"' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.changesets.outputs.published == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ fromJSON(steps.changesets.outputs.publishedPackages)[0].version }}
          name: Release v${{ fromJSON(steps.changesets.outputs.publishedPackages)[0].version }}
          body: |
            ## üì¶ Published Packages
            
            ${{ steps.format-packages.outputs.PACKAGES_TABLE }}
            
            See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
